
Ext.ns('app.crud.orm');app.crud.orm.canEdit=false;app.crud.orm.canDelete=false;app.crud.orm.foreignKeys=false;app.crud.orm.oList=[];app.crud.orm.intTypes=['tinyint','smallint','mediumint','int','bigint','boolean'];app.crud.orm.floatTypes=['decimal','float','double'];app.crud.orm.charTypes=['char','varchar'];app.crud.orm.textTypes=['tinytext','text','mediumtext','longtext'];app.crud.orm.dateTypes=['date','datetime','time','timestamp'];app.crud.orm.blobTypes=['tinyblob','blob','mediumblob','longblob'];app.crud.orm.Actions={};app.crud.orm.getObjectsList=function(){return app.crud.orm.oList;};Ext.define('app.crud.orm.Field',{extend:'Ext.data.Model',fields:[{name:'name',type:'string'},{name:'title',type:'string'},{name:'required',type:'boolean'},{name:'db_len',type:'integer'},{name:'db_isNull',type:'boolean'},{name:'db_default',type:'string'},{name:'is_search',type:'boolean'},{name:'system',type:'boolean'},{name:'type',type:'string'},{name:'unique',type:'boolean'},{name:'link_type',type:'string'},{name:'object',type:'string'},{name:'broken',type:'boolean'}]});Ext.define('app.crud.orm.Index',{extend:'Ext.data.Model',fields:[{name:'name',type:'string'},{name:'fulltext',type:'boolean'},{name:'unique',type:'boolean'},{name:'columns',type:'string'},{name:'primary',type:'boolean'}]});Ext.define('app.crud.orm.Main',{extend:'Ext.panel.Panel',dataStore:null,dataGrid:null,searchField:null,toolbarDataGrid:null,controllerUrl:'',layout:'fit',isSystemField:null,initComponent:function(){app.crud.orm.Actions={addDictionary:this.controllerUrl+'adddictionary',listDictionaries:this.controllerUrl+'listdictionaries',updateDictionary:this.controllerUrl+'updatedictionary',removeDictionary:this.controllerUrl+'removedictionary',listObj:this.controllerUrl+'list',listObjFields:this.controllerUrl+'fields',listObjIndexes:this.controllerUrl+'indexes',listBackups:this.controllerUrl+'listbackups',listAcl:this.controllerUrl+'listacl',loadObjCfg:this.controllerUrl+'load',loadObjField:this.controllerUrl+'loadfield',loadObjIndex:this.controllerUrl+'loadindex',makeBackUp:this.controllerUrl+'makebackup',removeBackUp:this.controllerUrl+'removebackup',removeObject:this.controllerUrl+'removeobject',restoreBackup:this.controllerUrl+'restorebackup',saveObjCfg:this.controllerUrl+'save',saveObjField:this.controllerUrl+'savefield',saveObjIndex:this.controllerUrl+'saveindex',deleteIndex:this.controllerUrl+'deleteindex',deleteField:this.controllerUrl+'deletefield',validateObject:this.controllerUrl+'validate',buildObject:this.controllerUrl+'build',buildAllObjects:this.controllerUrl+'buildall',builderLog:app.createUrl([this.controllerUrl+'log','']),dictionary:app.createUrl([this.controllerUrl+'dictionary','']),listValidators:app.createUrl([this.controllerUrl+'listvalidators','']),dataViewController:app.createUrl([this.controllerUrl+'dataview','']),connectionsUrl:app.createUrl([this.controllerUrl+'connections','']),listConnections:app.createUrl([this.controllerUrl+'connectionslist','']),importUrl:app.createUrl([this.controllerUrl+'import','']),encryptData:this.controllerUrl+'encryptdata',decryptData:this.controllerUrl+'decryptdata',taskStat:this.controllerUrl+'taskstat'};this.tbar=[];this.dataStore=Ext.create('Ext.data.Store',{model:'app.crud.orm.ObjectsModel',proxy:{type:'ajax',url:app.crud.orm.Actions.listObj,reader:{type:'json',rootProperty:'data',idProperty:'name'},actionMethods:{create:'POST',read:'POST',update:'POST',destroy:'POST'},simpleSortMode:true},autoLoad:true,sorters:[{property:'name',direction:'ASC'}],listeners:{scope:this,load:function(store,records){app.crud.orm.oList=[];Ext.each(records,function(record){var title=record.get('title');if(title.length)
title=' ('+title+')';app.crud.orm.oList.push({id:record.get('name'),title:(record.get('name')+title)});},this);}}});if(app.crud.orm.canEdit){this.tbar=[{text:appLang.ADD_OBJECT,tooltip:appLang.ADD_OBJECT,listeners:{click:{fn:function(){this.showEdit(null);},scope:this}}},{text:appLang.DICTIONARIES,tooltip:appLang.TOOLTIP_DICTIONARIES,listeners:{click:{fn:function(){this.showDictionary(false);},scope:this}}},{text:appLang.SHOW_OBJECTS_MAP,tooltip:appLang.TOOLTIP_OBJECTS_MAP,handler:this.showObjectsMap,scope:this},{text:appLang.DB_CONNECTIONS,handler:this.showConnections,scope:this},{text:appLang.DB_CONNECT_EXTERNAL,handler:this.importToOrm,scope:this},{text:appLang.SHOW_LOG,tooltip:appLang.BUILDER_SHOW_LOG,handler:this.showLog,scope:this}];}
this.isSystemField=Ext.create('Ext.form.Checkbox',{minWidth:10,listeners:{scope:this,change:function(field,value){if(value){this.dataStore.filter("system",false);}else{this.dataStore.clearFilter();this.searchField.startFilter();}}}});this.searchField=Ext.create('SearchPanel',{store:this.dataStore,fieldNames:['title','name','table'],local:true,listeners:{reset:{fn:function(){if(this.isSystemField.getValue()){this.dataStore.filter("system",false);}},scope:this}}});this.toolbarDataGrid=Ext.create('Ext.toolbar.Toolbar',{items:[{iconCls:'refreshIcon',tooltip:appLang.REFRESH,listeners:{click:{fn:function(){this.dataStore.load();},scope:this}}},this.searchField,'-',{xtype:'button',text:appLang.BUILD_ALL,tooltip:appLang.BUILD_ALL,iconCls:'buildIcon',scope:this,handler:this.rebuildAllObjects}]});this.toolbarDataGrid.add('-',' ',this.isSystemField,appLang.HIDE_SYSTEM_OBJ);this.dataGrid=Ext.create('app.crud.orm.dataGrid',{store:this.dataStore,tbar:this.toolbarDataGrid,loadMask:true,editable:true,viewConfig:{enableTextSelection:true},listeners:{'itemdblclick':{fn:function(view,record,number,event,options){this.showEdit(record);},scope:this},'editRecord':{fn:this.showEdit,scope:this},'rebuildTable':{fn:this.rebuildObject,scope:this},'removeItem':{fn:this.removeObject,scope:this},'viewData':{fn:this.showDataView,scope:this}}});this.items=[this.dataGrid];this.callParent();},removeObject:function(grid,rowIndex,colIndex){var store=grid.getStore();var rec=store.getAt(rowIndex);if(rec.get('external')){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_CANT_DELETE_EXTERNAL_OBJECT);return;}
var canDeleteTable=true;if(rec.get('locked')||rec.get('readonly')){canDeleteTable=false;}
var confirmForm=Ext.create('Ext.form.Panel',{bodyPadding:5,bodyCls:'formBody',items:[{xtype:'checkbox',boxLabel:appLang.DELETE_RELATED_TABLE,labelWidth:100,disabled:!canDeleteTable,name:'delete_table',listeners:{change:{fn:function(box,value){if(value){box.up('form').getForm().findField('notice').show();}else{box.up('form').getForm().findField('notice').hide();}}}}},{xtype:'displayfield',hidden:true,name:'notice',value:appLang.DELETE_RELATED_TABLE_NOTE}]});Ext.create('Ext.Window',{width:300,autoHeight:true,layout:'fit',modal:true,title:appLang.DELETE_OBJECT+' '+rec.get('name')+' "'+rec.get('title')+'"',items:[confirmForm],buttons:[{text:appLang.DELETE_OBJECT,handler:function(){var me=this;Ext.getBody().mask(appLang.MSG_OBJECT_REMOVING);Ext.Ajax.request({url:app.crud.orm.Actions.removeObject,method:'post',params:{'objectName':store.getAt(rowIndex).get('name'),'delete_table':confirmForm.getForm().findField('delete_table').getValue()},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){store.removeAt(rowIndex);store.load();}else{Ext.Msg.alert(appLang.MESSAGE,response.msg);}
Ext.getBody().unmask();me.up('window').close();},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION);Ext.getBody().unmask();}});}},{text:appLang.CANCEL,handler:function(){this.up('window').close();}}]}).show();},rebuildAllObjects:function(){Ext.Msg.confirm(appLang.CONFIRMATION,appLang.MSG_CONFIRM_REBUILD,function(btn){if(btn!='yes')
return;var oNamesList=[];this.dataStore.each(function(record){oNamesList.push(record.get('name'));},this);this.dataGrid.getEl().mask(appLang.SAVING);Ext.Ajax.request({url:app.crud.orm.Actions.buildAllObjects,method:'post',scope:this,timeout:3600000,params:{'names[]':oNamesList},success:function(response,request){this.dataGrid.getEl().unmask();response=Ext.JSON.decode(response.responseText);if(response.success){this.dataStore.load();}else{Ext.Msg.alert(appLang.MESSAGE,response.msg);}},failure:function(){this.dataGrid.getEl().unmask();Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION);}});},this);},showEdit:function(record){var oName=Ext.isEmpty(record)?'':record.get('name');var win=Ext.create('app.crud.orm.ObjectWindow',{objectName:oName,objectList:app.crud.orm.getObjectsList,isSystem:Ext.isEmpty(record)?false:record.get('system'),isExternal:Ext.isEmpty(record)?false:record.get('external')});win.setTitle(appLang.EDIT_OBJECT+' &laquo;'+oName+'&raquo; ');win.on('dataSaved',function(){this.dataStore.load();},this);win.on('showdictionarywin',function(name){this.showDictionary(name);},this);win.on('fieldRemoved',function(){this.dataStore.load();},this);win.on('indexRemoved',function(){this.dataStore.load();},this);win.show();},showDictionary:function(name){Ext.create('app.crud.orm.DictionaryWindow',{curDictionary:name,controllerUrl:app.crud.orm.Actions.dictionary,canEdit:app.crud.orm.canEdit,canDelete:app.crud.orm.canDelete}).show();},showObjectsMap:function(){Ext.create('app.crud.orm.ObjectsMapWindow',{controllerUrl:this.controllerUrl,canEdit:app.crud.orm.canEdit}).show();},rebuildObject:function(name)
{var handle=this;this.win=Ext.create('Ext.Window',{width:400,height:500,modal:true,scrollable:true,layout:'fit',title:appLang.REBUILD_INFO,closeAction:'destroy',buttons:[{text:appLang.CANCEL,scope:handle,handler:function(){this.win.close();}},{text:appLang.APPLY,scope:handle,handler:function(){this.buildObject(name);this.win.close();}}]});this.win.show();this.win.setLoading(appLang.FETCHING_INFO);Ext.Ajax.request({url:app.crud.orm.Actions.validateObject,method:'post',params:{'name':name},scope:this,timeout:3600000,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){if(response.nothingToDo){Ext.Msg.alert(appLang.MESSAGE,appLang.NTD);handle.win.close();}else{handle.win.add({xtype:'panel',scrollable:true,html:response.text,bodyPadding:3});}}else{Ext.Msg.alert(appLang.MESSAGE,response.msg);handle.win.close();}
handle.win.setLoading(false);},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION);handle.win.setLoading(false);}});},buildObject:function(name){var handle=this;Ext.Ajax.request({url:app.crud.orm.Actions.buildObject,method:'post',params:{'name':name},timeout:3600000,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){handle.dataStore.load();}else{Ext.Msg.alert('Error',response.msg);}},failure:app.formFailure});},showLog:function(){Ext.create('app.crud.orm.logWindow',{controllerUrl:app.crud.orm.Actions.builderLog}).show();},showDataView:function(record)
{var win=Ext.create('app.crud.orm.DataViewWindow',{objectName:record.get('name'),title:record.get('title'),isVc:record.get('vc'),readOnly:record.get('readonly'),primaryKey:record.get('primary_key'),controllerUrl:app.crud.orm.Actions.dataViewController});win.show();},showConnections:function()
{Ext.create('app.orm.connections.Window',{dbConfigs:app.crud.orm.dbConfigs,controllerUrl:app.crud.orm.Actions.connectionsUrl}).show();},importToOrm:function(){Ext.create('app.orm.import.Window',{dbConfigs:app.crud.orm.dbConfigs,controllerUrl:app.crud.orm.Actions.importUrl,listeners:{'importComplete':{fn:function(){this.dataGrid.getStore().load();},scope:this}}}).show();}});Ext.define('app.crud.orm.ObjectsModel',{extend:'Ext.data.Model',fields:[{name:'title',type:'string'},{name:'name',type:'string'},{name:'table',type:'string'},{name:'engine',type:'string'},{name:'vc',type:'boolean'},{name:'fields',type:'integer'},{name:'records',type:'string'},{name:'data_size',type:'string'},{name:'index_size',type:'string'},{name:'size',type:'string'},{name:'validdb',typr:'boolean'},{name:'title',typr:'string'},{name:'save_history',type:'boolean'},{name:'link_title',type:'string'},{name:'rev_control',type:'boolean'},{name:'system',type:'boolean'},{name:'db_host',type:'string'},{name:'db_name',type:'string'},{name:'broken',type:'boolean'},{name:'locked',type:'boolean'},{name:'readonly',type:'boolean'},{name:'can_connect',type:'boolean'},{name:'primary_key',type:'string'},{name:'connection',type:'string'}]});Ext.define('app.crud.orm.dataGrid',{extend:'Ext.grid.Panel',frame:false,loadMask:true,columnLines:true,scrollable:true,bodyBorder:false,border:false,editable:false,initComponent:function(){this.viewConfig={stripeRows:true,enableTextSelection:true};this.columns=[];if(this.editable)
{this.columns.push({xtype:'actioncolumn',align:'center',width:70,items:[{tooltip:appLang.EDIT_RECORD,iconCls:'editIcon',scope:this,handler:function(grid,rowIndex,colIndex){this.fireEvent('editRecord',grid.getStore().getAt(rowIndex));}},{tooltip:appLang.REBUILD_DB_TABLE,iconCls:'buildIcon',scope:this,handler:function(grid,rowIndex,colIndex){this.fireEvent('rebuildTable',grid.getStore().getAt(rowIndex).get('name'));}},{tooltip:appLang.VIEW_DATA,iconCls:'gridIcon',scope:this,handler:function(grid,rowIndex,colIndex){var rec=grid.getStore().getAt(rowIndex);this.fireEvent('viewData',rec);}}]});}
var rendererRecords=function(value,metaData,record,rowIndex,colIndex,store){if(record.get('external')){metaData.style='color:#0415D0;';}
if(record.get('engine')=='InnoDB'){value='~ '+value;}
return value;};var titleRenderer=function(value,metaData,record,rowIndex,colIndex,store){if(record.get('external')){metaData.style='color:#0415D0;';}
if(record.get('readonly')){value='<img src="'+app.wwwRoot+'i/system/plock.png" title="'+appLang.DB_READONLY_TOOLTIP+'" height="15"> '+value;}
if(record.get('locked')&&!record.get('readonly')){value='<img src="'+app.wwwRoot+'i/system/locked.png" title="'+appLang.DB_STRUCTURE_LOCKED_TOOLTIP+'" height="15"> '+value;}
if(record.get('broken'))
{metaData.style='background-color:red;';value='<img src="'+app.wwwRoot+'i/system/broken.png" title="'+appLang.BROKEN_LINK+'" height="15">&nbsp; '+value;}else if(!record.get('can_connect')){metaData.style='background-color:red;';value='<img src="'+app.wwwRoot+'i/system/broken.png" title="'+appLang.CANT_CONNECT+'" height="15">&nbsp; '+value;}
return value;};this.columns.push({text:appLang.TITLE,width:170,dataIndex:'title',renderer:titleRenderer},{text:appLang.OBJECT,dataIndex:'name',align:'left'},{text:appLang.DATA_TABLE,dataIndex:'table',align:'left',hidden:true},{text:appLang.PROPERTIES,dataIndex:'fields',align:'center'},{text:appLang.DB_STATE,columns:[{text:appLang.RECORDS,dataIndex:'records',align:'center',renderer:rendererRecords},{text:appLang.DATA_SIZE,dataIndex:'data_size',align:'center'},{text:appLang.INDEX_SIZE,dataIndex:'index_size',align:'center'},{text:appLang.SPACE_USAGE,dataIndex:'size',align:'center'}]},{text:appLang.DB_ENGINE,dataIndex:'engine',align:'center'},{sortable:true,text:appLang.VC,dataIndex:'vc',width:100,align:'center',renderer:app.checkboxRenderer},{text:appLang.VALID_DB,dataIndex:'validdb',align:'center',renderer:app.checkboxRenderer},{text:appLang.IS_SYSTEM,dataIndex:'system',align:'center',width:100,renderer:app.checkboxRenderer},{text:appLang.DB_HOST,align:'center',dataIndex:'db_host',width:100,hidden:true},{text:appLang.DB_NAME,align:'center',dataIndex:'db_name',width:100,hidden:true},{text:appLang.DB_CONNECTION,align:'center',dataIndex:'connection',width:120,hidden:true});if(this.editable)
{this.columns.push({xtype:'actioncolumn',align:'center',width:30,items:[{tooltip:appLang.DELETE_RECORD,iconCls:'deleteIcon',scope:this,handler:function(grid,rowIndex,colIndex){this.fireEvent('removeItem',grid,rowIndex,colIndex);}}]});}
this.callParent();}});Ext.define('app.crud.orm.ObjectWindow',{extend:'Ext.window.Window',objectName:null,dataGrid:null,indexGrid:null,indexStore:null,dataStore:null,configForm:null,tabPanel:null,objectList:null,isExternal:false,isSystem:false,maximizable:true,constructor:function(config){config=Ext.apply({modal:false,layout:'fit',width:app.checkWidth(700),height:app.checkHeight(550),closeAction:'destroy'},config||{});this.callParent(arguments);},initComponent:function(){this.dataStore=Ext.create('Ext.data.Store',{model:'app.crud.orm.Field',proxy:{type:'ajax',url:app.crud.orm.Actions.listObjFields,reader:{type:'json',rootProperty:'data',idProperty:'name'},extraParams:{'object':this.objectName},actionMethods:{create:'POST',read:'POST',update:'POST',destroy:'POST'},simpleSortMode:false},autoLoad:false,sorters:[{property:'system',direction:'DESC'},{property:'name',direction:'ASC'}]});this.indexStore=Ext.create('Ext.data.Store',{model:'app.crud.orm.Index',remoteSort:false,proxy:{type:'ajax',url:app.crud.orm.Actions.listObjIndexes,reader:{type:'json',rootProperty:'data',idProperty:'name'},extraParams:{'object':this.objectName},actionMethods:{create:'POST',read:'POST',update:'POST',destroy:'POST'},simpleSortMode:true},autoLoad:false,sorters:[{property:'name',direction:'ASC'}]});this.searchField=Ext.create('SearchPanel',{store:this.dataStore,fieldNames:['name','title'],local:true});var fieldsTbar=[];if(app.crud.orm.canEdit){fieldsTbar.push({text:appLang.ADD_FIELD,scope:this,handler:function(){this.showEditField(0);}});}
var me=this;var encryptButton=Ext.create('Ext.Button',{hidden:true,icon:app.wwwRoot+'i/system/plock.png',text:appLang.ENCRYPT_DATA,tooltip:appLang.ENCRYPT_DATA,handler:function(){this.encryptData(this.objectName);},scope:this});var decryptButton=Ext.create('Ext.Button',{hidden:true,icon:app.wwwRoot+'i/system/unlock.png',text:appLang.DECRYPT_DATA,tooltip:appLang.DECRYPT_DATA,handler:function(){this.decryptData(this.objectName);},scope:this});fieldsTbar.push('-');fieldsTbar.push(encryptButton);fieldsTbar.push(decryptButton);fieldsTbar.push('->');fieldsTbar.push(this.searchField);var titleRenderer=function(value,metaData,record,rowIndex,colIndex,store){if(record.get('broken'))
{metaData.style='background-color:red;';value='<img src="'+app.wwwRoot+'i/system/broken.png" title="'+appLang.BROKEN_LINK+'">&nbsp; '+value;}
return value;};this.dataGrid=Ext.create('Ext.grid.Panel',{store:this.dataStore,frame:false,loadMask:true,columnLines:true,scrollable:true,bodyBorder:false,border:false,title:appLang.FIELDS,tbar:fieldsTbar,encryptButton:encryptButton,decryptButton:decryptButton,defaults:{sortable:true},viewConfig:{stripeRows:true,enableTextSelection:true},forceFit:true,columns:[{width:50,align:'center',dataIndex:'name',colid:'editcolumn',renderer:function(value,metaData,record,rowIndex,colIndex,store){if(record.get('system')){return'<img src="'+app.wwwRoot+'i/system/locked.png" title="'+appLang.SYSTEM_PROTECTED_FIELD+'">';}
if(!record.get('system')&&app.crud.orm.canEdit){return'<img src="'+app.wwwRoot+'i/system/edit.png" title="'+appLang.EDIT_FIELD+'" style="cursor:pointer;">';}
return'';}},{text:appLang.TITLE,dataIndex:'title',align:'left',flex:1,width:100,renderer:titleRenderer},{text:appLang.FIELD_NAME,dataIndex:'name',width:120,align:'left'},{text:appLang.TYPE,dataIndex:'type',align:'center',width:80,colid:'link_type',scope:this,renderer:function(value,metaData,record,rowIndex,colIndex,store){if(record.get('link_type')=='dictionary'){metaData.style="background-color:#FFFDE4;cursor:pointer;height: 25px;";value='dictionary '+value;}
return value;}},{text:appLang.REQUIRED,dataIndex:'required',align:'center',width:60,renderer:app.checkboxRenderer},{text:'NULL',dataIndex:'db_isNull',align:'center',width:60,renderer:app.checkboxRenderer},{text:appLang.UNIQUE,dataIndex:'unique',align:'center',width:60,renderer:app.checkboxRenderer},{text:appLang.IS_SEARCH,dataIndex:'is_search',align:'center',width:60,renderer:app.checkboxRenderer},{width:40,align:'center',dataIndex:'name',colid:'deleteindex',renderer:function(value,metaData,record,rowIndex,colIndex,store){if(app.crud.orm.canDelete&&!record.get('system')){return'<img src="'+app.wwwRoot+'i/system/delete.png" title="'+appLang.DELETE_FIELD+'" style="cursor:pointer;">';}
return'';}}]});this.dataStore.on('load',function(store,records){var hasEncrypted=false;store.each(function(record){if(record.get('type')=='encrypted'){hasEncrypted=true;}});if(hasEncrypted){this.dataGrid.decryptButton.show();this.dataGrid.encryptButton.show();}else{this.dataGrid.encryptButton.hide();this.dataGrid.decryptButton.hide();}},this);this.indexGrid=Ext.create('Ext.grid.Panel',{store:this.indexStore,frame:false,loadMask:true,columnLines:true,scrollable:true,bodyBorder:false,border:false,title:appLang.INDEXES,defaults:{sortable:true},viewConfig:{stripeRows:true,enableTextSelection:true},forceFit:true,columns:[{width:40,align:'center',dataIndex:'name',colid:'editcolumn',renderer:function(value,metaData,record,rowIndex,colIndex,store){if(record.get('primary')){return'<img src="'+app.wwwRoot+'i/system/locked.png" title="'+appLang.SYSTEM_PROTECTED_INDEX+'">';}
if(app.crud.orm.canEdit){return'<img src="'+app.wwwRoot+'i/system/edit.png" title="'+appLang.EDIT_INDEX+'" style="cursor:pointer;">';}
return'';}},{text:appLang.NAME,dataIndex:'name',width:150,flex:1,align:'left'},{text:appLang.FULLTEXT,dataIndex:'fulltext',align:'center',width:70,renderer:app.checkboxRenderer},{text:appLang.UNIQUE,dataIndex:'unique',align:'center',width:70,renderer:app.checkboxRenderer},{text:appLang.COLUMNS,dataIndex:'columns',align:'center',width:200},{width:40,align:'center',dataIndex:'name',colid:'deleteindex',renderer:function(value,metaData,record,rowIndex,colIndex,store){if(app.crud.orm.canDelete&&!record.get('primary')){return'<img src="'+app.wwwRoot+'i/system/delete.png" title="'+appLang.EDIT_INDEX+'" style="cursor:pointer;">';}
return'';}}]});if(app.crud.orm.canEdit){var mainConfButtons=[{xtype:'button',text:appLang.SAVE,width:100,handler:this.saveMainCfg,scope:this}];this.dataGrid.on('itemdblclick',function(view,record,number,event,options){if(record.get('system'))
return;this.showEditField(record.get('name'));},this);this.indexGrid.on('itemdblclick',function(view,record,number,event,options){if(record.get('primary'))
return;this.showEditIndex(record.get('name'));},this);this.indexGrid.addDocked({dock:'top',xtype:'toolbar',items:[{text:appLang.ADD_INDEX,xtype:'button',scope:this,handler:function(){this.showEditIndex(0);}}]});}else{var mainConfButtons=[];}
if(app.crud.orm.canEdit||app.crud.orm.canDelete){this.indexGrid.on('cellclick',function(grid,cell,columnIndex,record,node,rowIndex,evt){var column=grid.getHeaderCt().getHeaderAtIndex(columnIndex).colid;if(record.get('primary'))
return;switch(column){case'editcolumn':if(!app.crud.orm.canEdit){return;}
this.showEditIndex(record.get('name'));break;case'deleteindex':if(!app.crud.orm.canDelete){return;}
this.deleteIndex(record.get('name'));break;}},this);this.dataGrid.on('cellclick',function(grid,cell,columnIndex,record,node,rowIndex,evt){var column=grid.getHeaderCt().getHeaderAtIndex(columnIndex).colid;if(record.get('system'))
return;switch(column){case'editcolumn':if(!app.crud.orm.canEdit){return;}
this.showEditField(record.get('name'));break;case'deleteindex':if(!app.crud.orm.canDelete){return;}
this.deleteField(record.get('name'));break;case'link_type':if(!app.crud.orm.canEdit){return;}
if(record.get('link_type')=='dictionary'){this.fireEvent('showdictionarywin',record.get('object'));}
break;}},this);}
this.configForm=Ext.create('Ext.form.Panel',{bodyPadding:3,frame:false,title:appLang.CONFIG,bodyCls:'formBody',bodyBorder:false,border:false,fieldDefaults:{labelWidth:180,labelAlign:'right',width:400},items:[{xtype:'checkbox',name:'rev_control',fieldLabel:appLang.VC,value:0,width:200,listeners:{render:{fn:this.initTooltip,scope:this}}},{xtype:'fieldcontainer',fieldLabel:appLang.HISTORY_LOG,combineErrors:true,msgTarget:'side',layout:'hbox',items:[{xtype:'checkbox',width:20,labelWidth:1,hideLabel:true,name:'save_history',listeners:{render:{fn:this.initTooltip,scope:this},change:function(box,value){var relatedField=this.configForm.getForm().findField('log_detalization');if(value){relatedField.show();}else{relatedField.hide();}},scope:this}},{xtype:'combobox',forceSelection:true,name:'log_detalization',fieldLabel:appLang.HISTORY_LOG_DETALIZATION,displayField:'title',valueField:'id',queryMode:'local',forceSelection:true,labelWidth:70,allowBlank:false,hidden:true,value:'default',width:195,store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',data:[{id:'default',title:"Default"},{id:'extended',title:"Extended"}]})}]},{xtype:'hiddenfield',name:'parent_object'},{xtype:'textfield',name:'name',fieldLabel:appLang.OBJECT_NAME,allowBlank:false,vtype:'alphanum',listeners:{render:{fn:this.initTooltip,scope:this}}},{xtype:'textfield',name:'title',fieldLabel:appLang.TITLE,allowBlank:false,listeners:{render:{fn:this.initTooltip,scope:this}}},{xtype:'textfield',name:'table',fieldLabel:appLang.TABLE_NAME,allowBlank:false,vtype:'alphanum',listeners:{render:{fn:this.initTooltip,scope:this}}},{xtype:'combobox',name:'engine',fieldLabel:appLang.TABLE_ENGINE,displayField:'title',valueField:'title',queryMode:'local',forceSelection:true,value:'InnoDB',store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',data:[{id:'myisam',title:"MyISAM"},{id:'innodb',title:"InnoDB"},{id:'memory',title:"Memory"}]}),allowBlank:false,listeners:{'change':{fn:function(combo,newValue,oldValue){if(!Ext.isEmpty(newValue)){this.checkFieldsValidation(newValue);}
if(!app.crud.orm.foreignKeys){return;}
var keysField=this.configForm.getForm().findField('disable_keys');if(newValue=='InnoDB'){keysField.show();}else{keysField.hide();}},scope:this},render:{fn:this.initTooltip,scope:this}}},{xtype:'checkbox',name:'disable_keys',fieldLabel:appLang.DISABLE_KEYS,value:0,hidden:true,listeners:{render:{fn:this.initTooltip,scope:this}}},{xtype:'combobox',name:'link_title',fieldLabel:appLang.MSG_FIELD_USED_AS_TITLE,store:this.dataStore,displayField:'title',valueField:'name',hidden:this.objectName?false:true,allowBlank:true,listeners:{render:{fn:this.initTooltip,scope:this}}},{xtype:'displayfield',fieldLabel:' ',labelSeparator:'',value:appLang.ADVANCED_OPTIONS+':'},{xtype:'combobox',name:'connection',fieldLabel:appLang.DB_CONNECTION,queryMode:'local',displayField:'id',forceSelection:true,allowBlank:false,valueField:'id',value:'default',store:Ext.create('Ext.data.Store',{fields:[{name:'id',type:'string'}],autoLoad:true,proxy:{type:'ajax',url:app.crud.orm.Actions.listConnections,reader:{type:'json',rootProperty:'data',idProperty:'id'}},remoteSort:false,sorters:[{property:'id',direction:'ASC'}]}),listeners:{render:{fn:this.initTooltip,scope:this}}},{xtype:'combobox',name:'slave_connection',fieldLabel:appLang.DB_SLAVE_CONNECTION,queryMode:'local',displayField:'id',forceSelection:true,allowBlank:true,valueField:'id',value:'',store:Ext.create('Ext.data.Store',{fields:[{name:'id',type:'string'}],autoLoad:true,proxy:{type:'ajax',url:app.crud.orm.Actions.listConnections,reader:{type:'json',rootProperty:'data',idProperty:'id'}},remoteSort:false,sorters:[{property:'id',direction:'ASC'}]}),listeners:{render:{fn:this.initTooltip,scope:this}}},{xtype:'textfield',allowBlank:false,vtype:'alpha',value:'id',fieldLabel:appLang.PRIMARY_KEY,name:'primary_key',listeners:{render:{fn:this.initTooltip,scope:this}}},{xtype:'checkbox',name:'readonly',hidden:true,fieldLabel:appLang.DB_READONLY,labelAlign:'right',listeners:{render:{fn:this.initTooltip,scope:this},'change':{fn:function(field,newValue,oldValue,options){var form=this.configForm.getForm();if(newValue){form.findField('locked').hide();}else{form.findField('locked').show();}},scope:this}}},{xtype:'checkbox',name:'locked',hidden:true,fieldLabel:appLang.DB_STRUCTURE_LOCKED,listeners:{render:{fn:this.initTooltip,scope:this}}},{xtype:'checkbox',name:'use_db_prefix',fieldLabel:appLang.DB_USE_PREFIX,checked:true,listeners:{render:{fn:this.initTooltip,scope:this}}},{xtype:'checkbox',name:'use_acl',fieldLabel:appLang.DB_USE_ACL,checked:false,listeners:{render:{fn:this.initTooltip,scope:this},'change':{fn:function(field,newValue,oldValue,options){var form=this.configForm.getForm();if(newValue){form.findField('acl').show();}else{form.findField('acl').hide();}},scope:this}}},{xtype:'combobox',name:'acl',fieldLabel:appLang.DB_ACL_ADAPTER,queryMode:'local',displayField:'title',forceSelection:true,allowBlank:true,valueField:'id',hidden:true,store:Ext.create('Ext.data.Store',{fields:[{name:'id',type:'string'},{name:'title',type:'string'}],autoLoad:true,proxy:{type:'ajax',url:app.crud.orm.Actions.listAcl,reader:{type:'json',rootProperty:'data',idProperty:'id'}},remoteSort:false,sorters:[{property:'id',direction:'ASC'}]}),listeners:{render:{fn:this.initTooltip,scope:this}}},{xtype:'fieldcontainer',fieldLabel:' ',labelSeparator:'',items:mainConfButtons}]});this.tabPanel=Ext.create('Ext.tab.Panel',{deferredRender:true,items:[this.configForm]});if(this.objectName){this.tabPanel.add(this.dataGrid);this.tabPanel.setActiveTab(1);this.tabPanel.add(this.indexGrid);this.dataStore.load();this.indexStore.load();}
this.items=[this.tabPanel];this.callParent(arguments);var form=this.configForm.getForm();form.findField('primary_key').setReadOnly(true);form.findField('primary_key').setFieldStyle({color:"#808080"});if(this.isSystem||this.isExternal)
{form.findField('name').setReadOnly(true);form.findField('name').setFieldStyle({color:"#808080"});}
if(this.objectName){var handle=this;handle.configForm.getForm().findField('readonly').show();handle.configForm.getForm().findField('locked').show();this.on('show',function(){var params=Ext.apply({object:this.objectName});this.configForm.getForm().load({url:app.crud.orm.Actions.loadObjCfg,params:params,waitMsg:appLang.LOADING,success:function(form,action)
{if(!action.result.success)
{if(action.result.errors!==false)
{var msg='';if(!Ext.isEmpty(action.result.errors.indexes)){msg+=appLang.UNAVAILABLE_INDEXES+' '+action.result.errors.indexes.join();}
msg+=' ';if(!Ext.isEmpty(action.result.errors.fields)){msg+=appLang.UNAVAILABLE_FIELDS+' '+action.result.errors.fields.join();}
Ext.Msg.alert(appLang.MESSAGE,msg);}else{Ext.Msg.alert(appLang.MESSAGE,action.result.msg);}}},failure:app.formFailure});},this);}},initTooltip:function(field){var name=field.name;var qTipName='qtip_object_'+name;if(Ext.isEmpty(ormTooltips[qTipName]))
return;Ext.create('Ext.tip.ToolTip',{target:field.getEl(),html:ormTooltips[qTipName]});},checkFieldsValidation:function(storageEngine){var msg='';var xFields=[];var xIndexes=[];switch(storageEngine.toLowerCase()){case'innodb':this.indexStore.each(function(rec){if(rec.get('fulltext')){xIndexes.push(rec.get('name'));}},this);break;case'memory':this.dataStore.each(function(rec){var type=rec.get('type');if(Ext.Array.indexOf(app.crud.orm.textTypes,type)!=-1||Ext.Array.indexOf(app.crud.orm.blobTypes,type)!=-1)
{xFields.push(rec.get('name'));}},this);this.indexStore.each(function(rec){if(rec.get('fulltext')){xIndexes.push(rec.get('name'));}},this);break;default:return;break;}
if(xIndexes.length){msg+=appLang.UNAVAILABLE_INDEXES+' ('+oldValue+'): '+xIndexes.join(', ');}
msg+='<br>';if(xFields.length){msg+=appLang.UNAVAILABLE_FIELDS+' ('+oldValue+'): '+xFields.join(', ');}
if(msg.length>4){combo.setValue(oldValue);Ext.Msg.alert(appLang.MESSAGE,msg);}},saveMainCfg:function()
{var handle=this;if(!this.configForm.getForm().isValid()){return;}
var isNew=false;if(Ext.isEmpty(handle.objectName)){isNew=true;}
this.configForm.getForm().submit({clientValidation:true,waitMsg:appLang.SAVING,method:'post',url:app.crud.orm.Actions.saveObjCfg,params:{record_id:this.objectName,'rev_control':this.configForm.getForm().findField('rev_control').getValue()},success:function(form,action){handle.objectName=handle.configForm.getForm().findField('name').getValue();handle.dataStore.proxy.setExtraParam('object',handle.objectName);handle.indexStore.proxy.setExtraParam('object',handle.objectName);if(isNew)
{handle.tabPanel.add(handle.dataGrid);handle.tabPanel.add(handle.indexGrid);handle.configForm.getForm().findField('readonly').show();handle.configForm.getForm().findField('locked').show();}
handle.configForm.getForm().findField('link_title').show();handle.dataStore.load();handle.indexStore.load();handle.setTitle(appLang.EDIT_OBJECT+' &laquo;'+handle.objectName+'&raquo; ');handle.fireEvent('dataSaved');},failure:function(form,action){if(action.result&&action.result.errors!==false){var msg='';if(!Ext.isEmpty(action.result.msg)){msg=action.result.msg+' ';}
if(!Ext.isEmpty(action.result.errors.indexes)){msg+=appLang.UNAVAILABLE_INDEXES+': '+action.result.errors.indexes.join(', ');}
msg+='<br>';if(!Ext.isEmpty(action.result.errors.fields)){msg+=appLang.UNAVAILABLE_FIELDS+': '+action.result.errors.fields.join(', ');}
Ext.Msg.alert(appLang.MESSAGE,msg);}else{Ext.Msg.alert(appLang.MESSAGE,action.result.msg);}}});},deleteIndex:function(name){var handle=this;Ext.Msg.confirm(appLang.CONFIRM,appLang.MSG_CONFIRM_DELETE+' "'+name+'"?',function(btn){if(btn!='yes'){return;}
Ext.Ajax.request({url:app.crud.orm.Actions.deleteIndex,method:'post',params:{'object':this.objectName,'name':name},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){handle.indexStore.load();handle.fireEvent('indexRemoved');}else{Ext.Msg.alert(appLang.MESSAGE,response.msg);}},failure:app.formFailure});},this);},deleteField:function(name){var handle=this;Ext.Msg.confirm(appLang.CONFIRM,appLang.MSG_CONFIRM_DELETE+' "'+name+'"?',function(btn){if(btn!='yes'){return;}
Ext.Ajax.request({url:app.crud.orm.Actions.deleteField,method:'post',params:{'object':this.objectName,'name':name},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){handle.dataStore.load();handle.indexStore.load();handle.fireEvent('fieldRemoved');}else{Ext.Msg.alert(appLang.MESSAGE,response.msg);}},failure:app.formFailure});},this);},showEditField:function(id){var win=Ext.create('app.crud.orm.FieldWindow',{objectName:this.objectName,fieldName:id,title:appLang.EDIT_FIELD,objectList:this.objectList(),dictionaryUrl:app.crud.orm.Actions.dictionary});win.setTableEngine(this.configForm.getForm().findField('engine').getValue());win.on('dataSaved',function(){this.dataStore.load();this.indexStore.load();this.fireEvent('dataSaved');},this);win.show();},showEditIndex:function(index){var cols=[];this.dataStore.each(function(rec){if(rec.get('link_type')!=='multi'){cols.push(rec.get('name'));}},this);var win=Ext.create('app.crud.orm.IndexWindow',{objectName:this.objectName,indexName:index,columnsList:cols,title:appLang.EDIT_INDEX});win.setTableEngine(this.configForm.getForm().findField('engine').getValue());win.on('dataSaved',function(){this.dataStore.load();this.indexStore.load();this.fireEvent('dataSaved');},this);win.show();},encryptData:function(objectName){var me=this;var objectTitle=this.configForm.getForm().findField('title').getValue();Ext.Msg.confirm(appLang.CONFIRM,appLang.MSG_CONFIRM_ENCRYPT+' "'+objectTitle+'" ?',function(btn){if(btn!='yes'){return;}
Ext.Ajax.request({url:app.crud.orm.Actions.encryptData,method:'post',scope:this,timeout:1000*60*60*24,params:{'object':objectName},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);}}});var win=Ext.create('app.crud.orm.taskStatusWindow',{title:'"'+objectTitle+'" '+appLang.ENCRYPT_DATA,controllerUrl:app.crud.orm.Actions.taskStat,extraParams:{'object':objectName,'type':'encrypt'}});win.on('failure',function(msg){Ext.Msg.alert(appLang.MESSAGE,msg);win.close();},me);win.on('finished',function(){this.dataGrid.getStore().load();},me);win.show();},this);},decryptData:function(objectName){var me=this;var objectTitle=this.configForm.getForm().findField('title').getValue();Ext.Msg.confirm(appLang.CONFIRM,appLang.MSG_CONFIRM_DECRYPT+' "'+objectTitle+'" ?',function(btn){if(btn!='yes'){return;}
Ext.Ajax.request({url:app.crud.orm.Actions.decryptData,method:'post',scope:this,timeout:1000*60*60*24,params:{'object':this.objectName},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);}}});var win=Ext.create('app.crud.orm.taskStatusWindow',{title:'"'+objectTitle+'" '+appLang.DECRYPT_DATA,controllerUrl:app.crud.orm.Actions.taskStat,extraParams:{'object':this.objectName,'type':'decrypt'}});win.on('failure',function(msg){Ext.Msg.alert(appLang.MESSAGE,msg);win.close();},me);win.on('finished',function(){this.dataGrid.getStore().load();},me);win.show();},this);}});Ext.define('app.crud.orm.FieldWindow',{extend:'Ext.window.Window',objectName:null,fieldName:null,dataForm:null,objectList:null,uniqueData:null,closeAction:'destroy',dictionaryUrl:null,constructor:function(config){config=Ext.apply({modal:true,layout:'fit',width:app.checkWidth(500),height:app.checkHeight(500),closeAction:'destroy',maximizable:true},config||{});this.callParent(arguments);},initComponent:function(){this.fieldDictionaries=Ext.create('Ext.form.field.ComboBox',{name:'dictionary',disabled:true,hidden:true,fieldLabel:appLang.DICTIONARY,queryMode:'local',displayField:'title',forceSelection:true,valueField:'id',store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',autoLoad:true,proxy:{type:'ajax',url:this.dictionaryUrl+'list',reader:{type:'json',rootProperty:'data',idProperty:'id'}},remoteSort:false,sorters:[{property:'title',direction:'ASC'}]}),listeners:{render:{fn:this.initTooltip,scope:this}}});this.fieldSetDefault=Ext.create('Ext.form.field.Checkbox',{name:'set_default',hidden:true,fieldLabel:appLang.SET_DEFAULT,listeners:{render:{fn:this.initTooltip,scope:this},change:{fn:this.setCheckDefault,scope:this}}});this.fieldDefaultNum=Ext.create('Ext.form.field.Number',{name:'db_default',disabled:true,hidden:true,fieldLabel:appLang.DEFAULT,listeners:{render:{fn:this.initTooltip,scope:this}}});this.fieldDefaultString=Ext.create('Ext.form.field.Text',{name:'db_default',disabled:true,hidden:true,fieldLabel:appLang.DEFAULT,listeners:{render:{fn:this.initTooltip,scope:this}}});this.fieldLen=Ext.create('Ext.form.field.Number',{name:'db_len',fieldLabel:appLang.DB_LENGTH,allowDecimals:false,disabled:true,hidden:true,value:1,minValue:1,listeners:{render:{fn:this.initTooltip,scope:this}}});this.fieldScale=Ext.create('Ext.form.field.Number',{name:'db_scale',fieldLabel:appLang.DB_SCALE,allowDecimals:false,disabled:true,hidden:true,minValue:0,value:3,listeners:{render:{fn:this.initTooltip,scope:this}}});this.fieldPrecision=Ext.create('Ext.form.field.Number',{name:'db_precision',fieldLabel:appLang.DB_PRECISION,allowDecimals:false,disabled:true,hidden:true,minValue:0,value:1,listeners:{render:{fn:this.initTooltip,scope:this}}});this.fieldType=Ext.create('Ext.form.field.ComboBox',{xtype:'combo',name:'db_type',fieldLabel:appLang.DB_TYPE,queryMode:'local',forceSelection:true,displayField:'title',valueField:'id',store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',remoteSort:false,sorters:[{property:'title',direction:'ASC'}]}),listeners:{select:function(field,value,options){this.dbTypeSelected(field.getValue());},render:{fn:this.initTooltip,scope:this},scope:this}});this.validatorField=Ext.create('Ext.form.field.ComboBox',{name:'validator',fieldLabel:appLang.VALIDATOR,queryMode:'local',displayField:'title',forceSelection:true,valueField:'id',store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',autoLoad:true,proxy:{type:'ajax',url:app.crud.orm.Actions.listValidators,reader:{type:'json',rootProperty:'data',idProperty:'id'}},remoteSort:false,sorters:[{property:'title',direction:'ASC'}]}),listeners:{render:{fn:this.initTooltip,scope:this}}});this.relationsType=this.fieldLinkType=Ext.create('Ext.form.RadioGroup',{fieldLabel:appLang.RELATIONSHIP_TYPE,columns:1,hidden:true,items:[{boxLabel:appLang.RELATIONSHIP_POLYMORPHIC,name:'relations_type',inputValue:'polymorphic',checked:true,listeners:{render:{fn:this.initTooltip,scope:this}}},{boxLabel:appLang.RELATIONSHIP_MANY_TO_MANY,name:'relations_type',inputValue:'many_to_many',listeners:{render:{fn:this.initTooltip,scope:this}}}]});this.fieldLinkType=Ext.create('Ext.form.RadioGroup',{fieldLabel:appLang.LINK_TYPE,columns:2,hidden:true,items:[{boxLabel:appLang.SINGLE_LINK,name:'link_type',inputValue:'object',checked:true,listeners:{'change':{fn:function(field,newValue,oldValue,options){if(newValue){this.processFields([this.fieldDictionaries,this.relationsType],[this.fieldObject,this.fieldRequired]);}},scope:this},render:{fn:this.initTooltip,scope:this}}},{boxLabel:appLang.MULTI_LINK,name:'link_type',inputValue:'multi',listeners:{'change':{fn:function(field,newValue,oldValue,options){if(newValue){this.processFields([this.fieldDictionaries,this.fieldRequired,],[this.fieldObject,this.relationsType]);}},scope:this},render:{fn:this.initTooltip,scope:this}}},{boxLabel:appLang.DICTIONARY,name:'link_type',inputValue:'dictionary',listeners:{'change':{fn:function(field,newValue,oldValue,options){if(newValue){this.processFields([this.fieldObject,this.relationsType],[this.fieldDictionaries,this.fieldRequired]);}},scope:this},render:{fn:this.initTooltip,scope:this}}}]});this.fieldObject=Ext.create('Ext.form.field.ComboBox',{xtype:'combo',name:'object',disabled:true,hidden:true,fieldLabel:appLang.OBJECT,queryMode:'local',valueField:'id',forceSelection:true,displayField:'title',store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',data:this.objectList,remoteSort:false,proxy:{type:'ajax'},sorters:[{property:'title',direction:'ASC'}]}),listeners:{render:{fn:this.initTooltip,scope:this}}});this.fieldIsNull=Ext.create('Ext.form.field.Checkbox',{xtype:'checkbox',name:'db_isNull',disabled:true,hidden:true,fieldLabel:appLang.IS_NULL,listeners:{'change':{fn:function(field,newValue,oldValue,options){if(newValue){this.fieldRequired.setValue(0);this.fieldRequired.hide();}else{this.fieldRequired.show();}},scope:this},render:{fn:this.initTooltip,scope:this}}});this.fieldRequired=Ext.create('Ext.form.field.Checkbox',{xtype:'checkbox',name:'required',disabled:true,hidden:true,fieldLabel:appLang.REQUIRED,listeners:{render:{fn:this.initTooltip,scope:this}}});this.fieldUnsigned=Ext.create('Ext.form.field.Checkbox',{xtype:'checkbox',name:'db_unsigned',disabled:true,hidden:true,fieldLabel:appLang.DB_UNSIGNED,listeners:{render:{fn:this.initTooltip,scope:this}}});this.fieldAllowHtml=Ext.create('Ext.form.field.Checkbox',{xtype:'checkbox',name:'allow_html',disabled:true,hidden:true,fieldLabel:appLang.ALLOW_HTML,listeners:{render:{fn:this.initTooltip,scope:this}}});this.fieldIsSearch=Ext.create('Ext.form.field.Checkbox',{xtype:'checkbox',name:'is_search',disabled:true,hidden:true,fieldLabel:appLang.IS_SEARCH,listeners:{render:{fn:this.initTooltip,scope:this}}});this.fieldUnique=Ext.create('Ext.form.field.Text',{name:'unique',disabled:false,hidden:false,fieldLabel:appLang.UNIQUE_GROUP,listeners:{render:{fn:this.initTooltip,scope:this}}});this.dataForm=Ext.create('Ext.form.Panel',{bodyPadding:3,frame:false,bodyCls:'formBody',bodyBorder:false,border:false,scrollable:true,fieldDefaults:{labelWidth:140,labelAlign:'right',anchor:'100%'},items:[{xtype:'textfield',name:'name',fieldLabel:appLang.FIELD_NAME,allowBlank:false,vtype:'alphanum',listeners:{render:{fn:this.initTooltip,scope:this}}},{xtype:'textfield',name:'title',allowBlank:false,fieldLabel:appLang.FIELD_TITLE,listeners:{render:{fn:this.initTooltip,scope:this}}},this.fieldUnique,{xtype:'radiogroup',columns:2,fieldLabel:appLang.FIELD_TYPE,items:[{boxLabel:appLang.FILED_STD,name:'type',inputValue:'',checked:true,listeners:{'change':{fn:function(field,newValue,oldValue,options){if(newValue){this.processFields([this.fieldLinkType,this.fieldObject],[this.fieldType]);this.dbTypeSelected(this.fieldType.getValue());}},scope:this},render:{fn:this.initTooltip,scope:this}}},{boxLabel:appLang.LINK,name:'type',inputValue:'link',listeners:{'change':{fn:function(field,newValue,oldValue,options){if(newValue){this.processFields([this.fieldSetDefault,this.fieldDefaultString,this.fieldDefaultNum,this.fieldType,this.fieldLen,this.fieldScale,this.fieldPrecision,this.fieldUnsigned,this.fieldAllowHtml,this.fieldIsSearch,this.fieldDictionaries,this.validatorField,this.fieldIsNull],[this.fieldLinkType,this.fieldObject,this.fieldRequired]);}},scope:this},render:{fn:this.initTooltip,scope:this}}},{boxLabel:appLang.ENCRYPTED_FIELD,name:'type',inputValue:'encrypted',listeners:{'change':{fn:function(field,newValue,oldValue,options){if(newValue){this.processFields([this.fieldDefaultNum,this.fieldType,this.fieldLen,this.fieldScale,this.fieldPrecision,this.fieldUnsigned,this.fieldIsSearch,this.fieldDictionaries,this.fieldLinkType,this.fieldObject,this.fieldIsNull,this.fieldAllowHtml],[this.fieldSetDefault,this.fieldDefaultString,this.validatorField,this.fieldRequired]);}},scope:this}}}]},this.fieldLinkType,this.relationsType,this.fieldObject,this.fieldType,this.validatorField,this.fieldLen,this.fieldScale,this.fieldPrecision,this.fieldSetDefault,this.fieldDefaultNum,this.fieldDefaultString,this.fieldIsNull,this.fieldUnsigned,this.fieldAllowHtml,this.fieldIsSearch,this.fieldDictionaries,this.fieldRequired]});if(app.crud.orm.canEdit){this.buttons=[{text:appLang.SAVE,scope:this,handler:this.saveAction},{text:appLang.CANCEL,scope:this,handler:this.close}];}
this.items=[this.dataForm];if(this.objectName&&this.fieldName){var handle=this;this.on('show',function(){var params=Ext.apply({object:this.objectName,field:this.fieldName});this.dataForm.getForm().load({url:app.crud.orm.Actions.loadObjField,params:params,scope:this,waitMsg:appLang.LOADING,success:function(form,action){if(!action.result.success){Ext.Msg.alert(appLang.MESSAGE,action.result.msg);}else{if(action.result.data.type=='link'){if(action.result.data.link_config.link_type=="dictionary"){this.fieldDictionaries.setValue(action.result.data.link_config.object);this.processFields([],[this.fieldRequired]);}
if(action.result.data.link_config.link_type=='object'){this.processFields([],[this.fieldRequired]);}}else{handle.dbTypeSelected(handle.fieldType.getValue());if(!Ext.isEmpty(action.result.data.db_default)){this.fieldDefaultString.setValue(action.result.data.db_default);}
if(action.result.data.db_default==false){if(Ext.isDefined(this.fieldDefaultString)){this.fieldDefaultString.reset();}
if(Ext.isDefined(this.fieldDefaultNumber)){this.fieldDefaultNumber.reset();}}}}},failure:app.formFailure});},this);}
this.callParent(arguments);},setTableEngine:function(engine){switch(engine){case'Memory':this.fillDbTypesStore([app.crud.orm.intTypes,app.crud.orm.floatTypes,app.crud.orm.charTypes,app.crud.orm.dateTypes]);break;default:this.fillDbTypesStore([app.crud.orm.intTypes,app.crud.orm.floatTypes,app.crud.orm.charTypes,app.crud.orm.dateTypes,app.crud.orm.textTypes]);break;}},fillDbTypesStore:function(arrayTypes){var data=[];Ext.each(arrayTypes,function(types){Ext.each(types,function(type){data.push({id:type,title:type});});});this.fieldType.getStore().loadData(data,false);},saveAction:function(){var handle=this;this.dataForm.getForm().submit({clientValidation:true,waitMsg:appLang.SAVING,method:'post',url:app.crud.orm.Actions.saveObjField,params:{'objectName':this.objectName,'objectField':this.fieldName},success:function(form,action){if(!action.result.success){Ext.Msg.alert(appLang.MESSAGE,action.result.msg);}else{handle.fireEvent('dataSaved');handle.close();}},failure:app.formFailure});},processFields:function(hide,show){Ext.each(hide,function(item){item.disable();item.hide();});Ext.each(show,function(item){item.enable();item.show();});if(!this.fieldSetDefault.getValue()){this.fieldDefaultString.disable();this.fieldDefaultNum.disable();}},dbTypeSelected:function(value)
{this.processFields([this.fieldDictionaries,this.fieldSetDefault,this.fieldDefaultString,this.fieldLen,this.fieldScale,this.fieldPrecision,this.fieldAllowHtml,this.fieldIsSearch],[this.fieldUnique,this.validatorField,this.fieldIsNull,this.fieldRequired,this.fieldUnsigned]);if(value=='boolean'){this.fieldDefaultNum.setMinValue(0);this.fieldDefaultNum.setMaxValue(1);this.processFields([this.validatorField,this.fieldUnsigned,this.fieldRequired],[this.fieldSetDefault,this.fieldDefaultNum]);return;}
this.fieldDefaultNum.setMinValue(Number.NEGATIVE_INFINITY);this.fieldDefaultNum.setMaxValue(Number.MAX_VALUE);if(Ext.Array.indexOf(app.crud.orm.intTypes,value)!=-1){this.processFields([],[this.fieldSetDefault,this.fieldDefaultNum]);return;}
if(Ext.Array.indexOf(app.crud.orm.floatTypes,value)!=-1){this.processFields([],[this.fieldSetDefault,this.fieldDefaultNum,this.fieldScale,this.fieldPrecision]);return;}
if(Ext.Array.indexOf(app.crud.orm.charTypes,value)!=-1){this.processFields([this.fieldDefaultNum,this.fieldUnsigned],[this.fieldSetDefault,this.fieldIsSearch,this.fieldAllowHtml,this.fieldDefaultString,this.fieldLen]);return;}
if(Ext.Array.indexOf(app.crud.orm.textTypes,value)!=-1){this.processFields([this.fieldSetDefault,this.fieldDefaultNum,this.fieldUnsigned,this.fieldDefaultString,this.fieldIsNull],[this.fieldIsSearch,this.fieldAllowHtml]);return;}
if(Ext.Array.indexOf(app.crud.orm.dateTypes,value)!=-1){this.processFields([this.fieldDefaultNum,this.fieldUnsigned,this.fieldIsNull],[]);return;}},setCheckDefault:function(field,newValue,oldValue,eOpts){fieldType=this.fieldType.getValue();var defField;if(Ext.Array.indexOf(app.crud.orm.intTypes,fieldType)!=-1||fieldType=='boolean'||Ext.Array.indexOf(app.crud.orm.floatTypes,fieldType)!=-1){defField=this.fieldDefaultNum;}else{defField=this.fieldDefaultString;}
if(newValue){defField.enable();}else{defField.disable();}},initTooltip:function(field){var name=field.name;var qTipName='qtip_field_'+name;if(Ext.isEmpty(ormTooltips[qTipName]))
return;Ext.create('Ext.tip.ToolTip',{target:field.getEl(),html:ormTooltips[qTipName],});}});Ext.define('app.crud.orm.IndexWindow',{extend:'Ext.window.Window',objectName:null,indexName:null,dataForm:null,columnsMenu:null,columnsList:null,columnsData:null,fieldFullText:null,fieldUnique:null,constructor:function(config){config=Ext.apply({modal:true,layout:'fit',width:app.checkWidth(350),height:app.checkHeight(200),closeAction:'destroy',maximizable:true},config||{});this.columnsData=[];this.callParent(arguments);},initComponent:function(){this.columnsMenu=Ext.create('Ext.menu.Menu',{});this.buildMenu();this.fieldFullText=Ext.create('Ext.form.field.Checkbox',{xtype:'checkbox',name:'fulltext',fieldLabel:appLang.FULLTEXT,listeners:{scope:this,change:function(field,newValue){if(newValue){this.fieldUnique.setValue(false);}}}});this.fieldUnique=Ext.create('Ext.form.field.Checkbox',{xtype:'checkbox',name:'unique',fieldLabel:appLang.UNIQUE,listeners:{scope:this,change:function(field,newValue){if(newValue){this.fieldFullText.setValue(false);}}}});this.dataForm=Ext.create('Ext.form.Panel',{bodyPadding:3,frame:false,bodyCls:'formBody',bodyBorder:false,border:false,fieldDefaults:{labelWidth:80,labelAlign:'left',anchor:'100%'},items:[{xtype:'textfield',name:'name',fieldLabel:appLang.NAME,allowBlank:false,vtype:'alphanum'},{xtype:'fieldcontainer',fieldLabel:appLang.COLUMNS,allowBlank:false,layout:'hbox',items:[{xtype:'textfield',readOnly:true,name:'columns',submitValue:false,flex:1},{xtype:'button',iconCls:'findIcon',menu:this.columnsMenu}]},this.fieldUnique,this.fieldFullText]});if(app.crud.orm.canEdit){this.buttons=[{text:appLang.SAVE,scope:this,handler:this.saveAction},{text:appLang.CANCEL,scope:this,handler:this.close}];}
this.items=[this.dataForm];if(this.objectName&&this.indexName){var handle=this;this.on('show',function(){var params=Ext.apply({object:this.objectName,index:this.indexName});this.dataForm.getForm().load({url:app.crud.orm.Actions.loadObjIndex,params:params,waitMsg:appLang.LOADING,success:function(form,action){if(!action.result.success){Ext.Msg.alert(appLang.MESSAGE,action.result.msg);}else{handle.columnsData=action.result.data.columns;handle.refreshColumns();handle.checkMenu();}},failure:app.formFailure});},this);}else{}
this.callParent(arguments);},processFields:function(hide,show){Ext.each(hide,function(item){item.disable();item.hide();});Ext.each(show,function(item){item.enable();item.show();});},setTableEngine:function(engine){switch(engine){case'Memory':this.processFields([this.fieldFullText],[]);break;case'InnoDB':this.processFields([this.fieldFullText],[]);break;default:this.processFields([],[this.fieldFullText]);break;}},buildMenu:function(){Ext.each(this.columnsList,function(record){this.columnsMenu.add({text:record,scope:this,checked:false,checkHandler:this.menuChecked});},this);},checkMenu:function(){this.columnsMenu.items.each(function(item){var checked=false;if(Ext.Array.indexOf(this.columnsData,item.text)!=-1){item.setChecked(true,true);}else{item.setChecked(false,true);}},this);},menuChecked:function(item,checked){if(checked){this.columnsData.push(item.text);}else{Ext.Array.remove(this.columnsData,item.text);}
this.refreshColumns();},saveAction:function(){var handle=this;this.dataForm.getForm().submit({clientValidation:true,waitMsg:appLang.SAVING,method:'post',url:app.crud.orm.Actions.saveObjIndex,params:{object:this.objectName,index:this.indexName,'columns[]':this.columnsData},success:function(form,action){if(!action.result.success){Ext.Msg.alert(appLang.MESSAGE,action.result.msg);}else{handle.fireEvent('dataSaved');handle.close();}},failure:app.formFailure});},refreshColumns:function(){var colField=this.dataForm.getForm().findField('columns');var s='';Ext.each(this.columnsData,function(item){s+=item+', ';},this);colField.setValue(s);}});Ext.define('app.crud.orm.DictionaryRecordModel',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'key',type:'string'},{name:'value',type:'string'}],idProperty:'id'});Ext.define('app.crud.orm.AddDictionaryWindow',{extend:'Ext.window.Window',dataForm:null,dictionryId:null,valueField:'',constructor:function(config){config=Ext.apply({layout:'fit',modal:true,bodyCls:'formBody',width:app.checkWidth(300),height:app.checkHeight(120),closeAction:'destroy',resizable:false,title:appLang.DICTIONARY_NAME},config||{});this.callParent(arguments);},initComponent:function(){this.dataForm=Ext.create('Ext.form.Panel',{border:false,bodyPadding:15,bodyCls:'formBody',layout:'anchor',defaults:{anchor:'100%'},items:[{xtype:'hidden',name:'id',value:this.dictionryId},{xtype:'textfield',fieldLabel:appLang.NAME,name:'name',allowBlank:false,vtype:"alpha",labelWidth:50,value:this.valueField}]});this.buttons=[{text:appLang.SAVE,scope:this,handler:this.saveNewDictionary}];this.items=[this.dataForm];this.callParent(arguments);},saveNewDictionary:function(){this.dataForm.getForm().submit({clientValidation:true,waitMsg:appLang.SAVING,method:'post',scope:this,url:this.controllerUrl+'update',success:function(form,action){if(!action.result.success){Ext.Msg.alert(appLang.MESSAGE,action.result.msg);}else{this.fireEvent('dictionarySaved',form.findField('name').getValue());this.close();}},failure:app.formFailure});}});Ext.define('app.crud.orm.DictionaryWindow',{extend:'Ext.window.Window',curDictionary:null,canEdit:false,canDelete:false,addRecordButton:null,saveRecordsButton:null,renameDictionaryButton:null,dictionaryGrid:null,recordsGrid:null,dictionaryStore:null,recordsStore:null,cellEditingRecords:null,controllerUrl:'',constructor:function(config){config=Ext.apply({layout:'border',modal:true,width:app.checkWidth(700),height:app.checkHeight(500),closeAction:'destroy',maximizable:true,title:appLang.DICTIONARIES},config||{});this.callParent(arguments);},initComponent:function(){this.dictionaryStore=Ext.create('Ext.data.Store',{model:'app.comboStringModel',proxy:{type:'ajax',url:this.controllerUrl+'list',reader:{type:'json',rootProperty:'data',idProperty:'id'}},autoLoad:true,sorters:[{property:'title',direction:'ASC'}],listeners:{scope:this,load:this.selectCurentItem}});var dictionaryGridColumns=[{text:appLang.NAME,flex:1,dataIndex:'title'}];if(this.canDelete){dictionaryGridColumns.push({xtype:'actioncolumn',width:20,align:'center',itemId:'removeAction',items:[{iconCls:'deleteIcon',width:20,tooltip:appLang.DELETE,scope:this,handler:this.deleteDictionary}]});}
this.dictionaryGrid=Ext.create('Ext.grid.Panel',{region:'center',store:this.dictionaryStore,layout:'fit',columnLines:true,columns:dictionaryGridColumns,viewConfig:{enableTextSelection:true}});this.renameDictionaryButton=Ext.create('Ext.button.Button',{text:appLang.RENAME,scope:this,handler:this.updateDictionary,disabled:true});if(this.canEdit){this.dictionaryGrid.addDocked({xtype:'toolbar',dock:'top',items:[{text:appLang.ADD,scope:this,handler:this.addDictionary},this.renameDictionaryButton]});}
this.dictionaryGrid.on('cellclick',this.onDictionaryClick,this);this.cellEditingRecords=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.recordsStore=Ext.create('Ext.data.Store',{model:'app.crud.orm.DictionaryRecordModel',proxy:{type:'ajax',url:this.controllerUrl+'records',reader:{type:'json',rootProperty:'data'}},autoLoad:false,sorters:[{property:'key',direction:'ASC'}]});this.addRecordButton=Ext.create('Ext.button.Button',{text:appLang.ADD,scope:this,handler:this.addDictionaryRec,disabled:true});this.saveRecordsButton=Ext.create('Ext.button.Button',{text:appLang.SAVE,scope:this,handler:this.saveDictionaryRec,disabled:true});var recordsGridColumns=[{text:appLang.KEY,flex:1,dataIndex:'key',editor:{allowBlank:false,vtype:"alphanum"}},{text:appLang.VALUE,dataIndex:'value',editor:{allowBlank:false}}];if(this.canDelete){recordsGridColumns.push({xtype:'actioncolumn',width:20,align:'center',itemId:'removeAction',items:[{iconCls:'deleteIcon',width:20,tooltip:appLang.DELETE,scope:this,handler:this.deleteDictionaryRec}]});}
this.recordsGrid=Ext.create('Ext.grid.Panel',{region:'east',width:350,columnLines:true,split:true,store:this.recordsStore,plugins:[this.cellEditingRecords],layout:'fit',columns:recordsGridColumns,viewConfig:{enableTextSelection:true}});if(this.canEdit){this.recordsGrid.addDocked([{xtype:'toolbar',dock:'top',items:[this.addRecordButton]},{xtype:'toolbar',dock:'bottom',ui:'footer',defaults:{minWidth:75},items:['->',this.saveRecordsButton]}]);}
this.items=[this.dictionaryGrid,this.recordsGrid];this.callParent(arguments);if(this.curDictionary){this.loadRecordsStore();}},selectCurentItem:function(){if(this.curDictionary){var toSelect=null;this.dictionaryStore.each(function(record){if(record.get('title')==this.curDictionary){toSelect=record;return false;}},this);if(toSelect!=null){this.dictionaryGrid.getSelectionModel().select(toSelect);}}},setDisabledRenameButton:function(bool){this.renameDictionaryButton.setDisabled(bool);},onDictionaryClick:function(grid,cell,columnIndex,record,node,rowIndex,evt){var cellId=grid.getHeaderAtIndex(columnIndex).itemId;if(cellId=='removeAction'){return;}
this.setDisabledRenameButton(false);this.setCurDictionary(record.get('id'),true);},setCurDictionary:function(name,load){this.curDictionary=name;if(load){this.loadRecordsStore();}},loadRecordsStore:function(){this.unsetCurDictionary();this.recordsStore.proxy.setExtraParam('dictionary',this.curDictionary);this.recordsStore.load({scope:this,callback:function(records,operation,success){if(success){this.addRecordButton.enable();this.saveRecordsButton.enable();}}});},unsetCurDictionary:function(){this.recordsStore.removeAll();this.addRecordButton.disable();this.saveRecordsButton.disable();},addDictionary:function(grid,rowIndex,colIndex){var win=Ext.create('app.crud.orm.AddDictionaryWindow',{controllerUrl:this.controllerUrl});win.on('dictionarySaved',function(){this.dictionaryStore.load();this.setDisabledRenameButton(true);},this);win.show();},addDictionaryRec:function(){var r=Ext.create('app.crud.orm.DictionaryRecordModel');var pos=this.recordsStore.getCount();r.set({key:'new',value:'empty','id':pos},{dirty:true});this.recordsStore.insert(pos,r);var index=this.recordsStore.findExact('id',pos);if(index>=0){this.cellEditingRecords.startEdit({row:index,column:0});}},updateDictionary:function(){var record=this.dictionaryGrid.getView().getSelectionModel().getSelection()[0];if(record){var win=Ext.create('app.crud.orm.AddDictionaryWindow',{controllerUrl:this.controllerUrl,dictionryId:record.get('id'),valueField:record.get('title')});win.on('dictionarySaved',function(newTitle){this.setCurDictionary(newTitle,false);this.dictionaryStore.load();this.setDisabledRenameButton(true);},this);win.show();}else{Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_SELECT_RECORD);}},saveDictionaryRec:function()
{var data=app.collectStoreData(this.recordsStore,'id');if(data.length==0){Ext.Msg.alert(appLang.MESSAGE,appLang.NTD);return;}
Ext.Ajax.request({url:this.controllerUrl+'updaterecords',method:'post',params:{data:Ext.JSON.encode(data),dictionary:this.curDictionary},scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);}else{this.loadRecordsStore();}},failure:app.ajaxFailure});},deleteDictionary:function(grid,rowIndex,colIndex,item,eventObj){var name=grid.getStore().getAt(rowIndex).get('id');Ext.Msg.confirm(appLang.CONFIRM,appLang.MSG_CONFIRM_DELETE_DICTIONARY+' "'+name+'"?',function(btn){if(btn!='yes'){return;}
Ext.Ajax.request({url:this.controllerUrl+'remove',method:'post',scope:this,params:{name:name},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){grid.getStore().removeAt(rowIndex);if(name==this.curDictionary){this.unsetCurDictionary();this.setDisabledRenameButton(true);}}else{Ext.Msg.alert(appLang.MESSAGE,response.msg);}},failure:app.ajaxFailure});},this);},deleteDictionaryRec:function(grid,rowIndex,colIndex,item,eventObj){var record=grid.getStore().getAt(rowIndex);if(record.dirty){grid.getStore().remove(record);return;}
var name=record.get('id');Ext.Msg.confirm(appLang.CONFIRM,appLang.MSG_CONFIRM_DELETE+' "'+name+'"?',function(btn){if(btn!='yes'){return;}
Ext.Ajax.request({url:this.controllerUrl+'removerecords',method:'post',scope:this,params:{name:name,dictionary:this.curDictionary},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.recordsStore.removeAt(rowIndex);}else{Ext.Msg.alert(appLang.MESSAGE,response.msg);}},failure:app.ajaxFailure});},this);}});Ext.define('app.crud.orm.ObjectsMapWindow',{extend:'Ext.window.Window',maximizable:true,controllerUrl:'',plain:true,layout:'fit',scrollable:true,maximized:true,modal:true,width:app.checkWidth(700),height:app.checkHeight(500),title:appLang.SHOW_OBJECTS_MAP,uml:null,umlDefaultOptions:{placeholder:'diagram',stateColorFill:'90-#333-#5C95BE:1-#9BC7E3',renderOnResize:false},umlOptions:{},umlData:null,drawEl:null,firstElement:null,allItems:{},allIsRendered:false,mapWidth:100,mapHeight:100,canEdit:false,initComponent:function(){this.drawEl=Ext.create('Ext.Component',{html:'<div id="diagram"></div>',padding:0,style:{color:'#000'}});if(this.canEdit)
{this.tbar=[{text:appLang.SAVE,iconCls:'saveIcon',handler:this.saveMap,scope:this}];}
this.items=[this.drawEl];this.callParent();this.createUml();},createUml:function(){this.umlOptions=Ext.apply(this.umlDefaultOptions,this.umlOptions);if(this.umlOptions.renderOnResize){this.on('resize',function(){this.renderUML();},this);}
this.uml=Joint.dia.uml;this.loadData();},renderUML:function(){if(typeof(this.umlData)!='undefined'){this.allItems={};var itemWidth=120,paperWidth=this.mapWidth,paperHeight=this.mapHeight;Joint.paper(this.umlOptions.placeholder,paperWidth,paperHeight);Ext.Object.each(this.umlData,function(index,item){var objectFields=[];for(var i=0,len=item.fields.length;i<len;i++){objectFields.push((i+1));objectFields.push(item.fields[i]);}
var elemHeight=(12*i)+30;this.allItems[index]=this.createUmlState(item.position,itemWidth,elemHeight,index,objectFields);this.allItems[index].isRendered=true;},this);this.linkUmlStates();}},createUmlState:function(position,itemWidth,itemHeight,title,objectFields){return this.uml.State.create({rect:{x:position.x,y:position.y,width:itemWidth,height:itemHeight},label:title,attrs:{fill:this.umlOptions.stateColorFill},actions:{inner:objectFields}}).toggleGhosting();},linkUmlStates:function(){if(!this.allIsRendered)
for(var umlItem in this.umlData){for(var umlItemLink in this.umlData[umlItem].links){var linkLabel=[];for(var umlItemLinkLabel in this.umlData[umlItem].links[umlItemLink]){if(this.umlData[umlItem].links[umlItemLink][umlItemLinkLabel]=='object'||this.umlData[umlItem].links[umlItemLink][umlItemLinkLabel]=='multi'){linkLabel.push(umlItemLinkLabel);}}
if(typeof this.allItems[umlItemLink]!='undefined')this.allItems[umlItem].joint(this.allItems[umlItemLink],this.uml.arrow).label(linkLabel.join(', '));}}
this.allIsRendered=true;},loadData:function(){Ext.Ajax.request({url:this.controllerUrl+'getumldata',method:'post',scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);}else{this.umlData=response.data.items;this.mapWidth=response.data.mapWidth;this.mapHeight=response.data.mapHeight;this.renderUML();}},failure:app.ajaxFailure});},saveMap:function(){var map={};var drawX=this.drawEl.getEl().getX();var drawY=this.drawEl.getEl().getY();Ext.Object.each(this.allItems,function(index,item){var x,y;x=item.properties.rect.x+item.properties.dx;y=item.properties.rect.y+item.properties.dy;map[index]={'x':x,'y':y};},this);this.getEl().mask(appLang.SAVING);Ext.Ajax.request({url:this.controllerUrl+'saveumlmap',method:'post',scope:this,params:{map:Ext.JSON.encode(map)},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);}
this.getEl().unmask();},failure:function(){this.getEl().unmask();app.ajaxFailure(arguments);}});}});Ext.define('app.crud.orm.DataViewWindow',{extend:'Ext.window.Window',objectName:'',controllerUrl:'',width:800,height:600,maximizable:true,readOnly:false,layout:'fit',dataGrid:null,dataStore:null,searchField:null,isVc:null,primaryKey:'id',editorCfg:false,selectMode:false,closeOnSelect:true,modal:true,relatedGrids:null,initComponent:function(){if(this.selectMode){this.buttons=[{text:appLang.SELECT,scope:this,handler:this.selectItem},{text:appLang.CLOSE,scope:this,handler:this.close}];}
this.callParent();this.on('show',function(){app.checkSize(this);this.loadInterface();},this);},loadInterface:function(){var me=this;me.getEl().mask(appLang.LOADING);Ext.Ajax.request({url:this.controllerUrl+'viewconfig',method:'post',params:{object:this.objectName},scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);}else{this.configurate(response.data);}
me.getEl().unmask();},failure:function(){me.getEl().unmask();app.ajaxFailure(arguments);}});},configurate:function(data){this.dataStore=Ext.create('Ext.data.Store',{fields:data.fields,remoteSort:true,proxy:{type:'ajax',url:this.controllerUrl+'list',directionParam:"pager[dir]",limitParam:"pager[limit]",simpleSortMode:true,sortParam:"pager[sort]",startParam:"pager[start]",extraParams:{object:this.objectName},reader:{type:'json',idProperty:"id",rootProperty:"data",totalProperty:"count"},simpleSortMode:true},autoLoad:true});var cols=[];if(!this.selectMode)
{cols.push({xtype:'actioncolumn',width:30,items:[{iconCls:'editIcon',scope:this,tooltip:appLang.EDIT,handler:function(grid,rowIndex,colIndex){var rec=grid.getStore().getAt(rowIndex);this.showEdit(rec.get('id'));}}]});}
Ext.each(data.columns,function(item){cols.push(item);});var tBar=[];if(!this.selectMode&&!this.readOnly)
{tBar.push({text:appLang.ADD_ITEM,scope:this,handler:function(){this.showEdit(0);}});}
this.searchField=Ext.create('SearchPanel',{store:this.dataStore,isLocal:false,fieldNames:data.searchFields});tBar.push('->',this.searchField);this.dataGrid=Ext.create('Ext.grid.Panel',{columns:cols,selModel:Ext.create('Ext.selection.RowModel',{mode:'single'}),columnLines:true,store:this.dataStore,loadMask:true,tbar:tBar,viewConfig:{enableTextSelection:true},bbar:Ext.create("Ext.PagingToolbar",{store:this.dataStore,displayInfo:true,displayMsg:appLang.DISPLAYING_RECORDS+" {0} - {1} "+appLang.OF+" {2}",emptyMsg:appLang.NO_RECORDS_TO_DISPLAY})});if(this.selectMode){this.dataGrid.on('celldblclick',function(table,td,cellIndex,record,tr,rowIndex,e,eOpts){this.fireEvent('select',record);if(this.closeOnSelect){this.close();}},this);}else{this.dataGrid.on('celldblclick',function(table,td,cellIndex,record,tr,rowIndex,e,eOpts){this.showEdit(record.get(this.primaryKey));},this);}
this.add(this.dataGrid);},selectItem:function()
{var sm=this.dataGrid.getSelectionModel();if(!sm.hasSelection()){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_SELECT_ITEM_FOR_ADDING);return;}
this.fireEvent('select',sm.getSelection()[0]);if(this.closeOnSelect){this.close();}},showEdit:function(id)
{if(!this.editorCfg)
{var me=this;me.getEl().mask(appLang.LOADING);Ext.Ajax.request({url:this.controllerUrl+'editorconfig',method:'post',params:{object:this.objectName},scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);}else{me.editorCfg=response.data;me.createEditWindow(id);}
me.getEl().unmask();},failure:function(){me.getEl().unmask();app.ajaxFailure(arguments);}});}else{this.createEditWindow(id);}},createEditWindow:function(id)
{var win;var me=this;var related=this.editorCfg.related;var fields=Ext.JSON.decode(this.editorCfg.fields);this.relatedGrids=[];if(!Ext.isEmpty(related)){Ext.each(related,function(item){var grid=Ext.create('app.relatedGridPanel',{title:item.title,fieldName:item.field,listeners:{addItemCall:{fn:function(){Ext.create('app.crud.orm.DataViewWindow',{width:600,height:500,selectMode:true,closeOnSelect:false,objectName:item.object,controllerUrl:this.controllerUrl,isVc:this.isVc,title:item.title,readOnly:this.editorCfg.readOnly,primaryKey:this.editorCfg.primaryKey,listeners:{scope:this,select:function(record){if(record.get('published')!=undefined){published=record.get('published');}else{published=1;}
me.relatedGrids[item.field].addRecord(app.relatedGridModel.create({'id':record.get('id'),'published':published,'title':record.get(item.titleField),'deleted':0}));}}}).show();},scope:this}}});this.relatedGrids[item.field]=grid;fields.push(grid);},this);}
if(this.isVc){win=Ext.create('app.contentWindow',{width:800,height:800,objectName:this.objectName,hasPreview:false,items:fields,dataItemId:id,primaryKey:this.primaryKey,controllerUrl:this.controllerUrl+app.createUrl(['editorvc','']),canEdit:!this.readOnly,canDelete:!this.readOnly,canPublish:!this.readOnly,listeners:{dataSaved:{fn:function(){me.dataStore.load();},scope:me}}});}else{win=Ext.create('app.editWindow',{width:800,height:800,dataItemId:id,canEdit:!this.readOnly,canDelete:!this.readOnly,primaryKey:this.primaryKey,items:fields,objectName:this.objectName,controllerUrl:this.controllerUrl+app.createUrl(['editor','']),listeners:{dataSaved:{fn:function(){me.dataStore.load();},scope:me}}});}
win.show();}});Ext.define('app.crud.orm.ObjectField',{extend:'Ext.form.FieldContainer',alias:'widget.objectfield',triggerCls:'urlTrigger',dataField:null,triggerButton:null,layout:'vbox',onlyController:false,controllerUrl:'',objectName:'',value:"",isVc:'',fieldLabel:'',initComponent:function(){var me=this;this.dataField=Ext.create('Ext.form.field.Text',{anchor:"100%",readOnly:true,name:this.name,listeners:{change:{fn:this.getObjectTitle,scope:this}}});this.dataFieldLabel=Ext.create('Ext.form.field.Display',{anchor:"100%",value:"..."});this.triggerButton=Ext.create('Ext.button.Button',{iconCls:'searchIcon',width:20,scope:me,tooltip:appLang.SELECT,handler:function(){var win=Ext.create('app.crud.orm.DataViewWindow',{width:600,height:500,selectMode:true,objectName:this.objectName,controllerUrl:this.controllerUrl,isVc:this.isVc,title:this.fieldLabel,listeners:{scope:me,select:function(record){me.setValue(record.get('id'));me.fireEvent('completeEdit');}}});win.show();app.checkSize(win);}});this.removeButton=Ext.create('Ext.button.Button',{iconCls:'deleteIcon',width:20,tooltip:appLang.CLEAR,scope:me,handler:function(){me.setValue("");}});var valueContainer={anchor:"100%",xtype:'fieldcontainer',layout:'hbox',items:[this.dataField,this.triggerButton,this.removeButton]};this.items=[this.dataFieldLabel,valueContainer];this.callParent();},setValue:function(value){this.dataField.setValue(value);},getValue:function(){return this.dataField.getValue();},reset:function(){this.dataField.reset();},isValid:function(){return true;},getObjectTitle:function(){var me=this;var curValue=me.getValue();if(curValue==""||curValue==0){me.dataFieldLabel.setValue('');return;}
me.dataFieldLabel.getEl().mask(appLang.LOADING);Ext.Ajax.request({url:this.controllerUrl+'otitle',method:'post',params:{object:this.objectName,id:curValue},scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){me.dataFieldLabel.getEl().unmask();Ext.Msg.alert(appLang.MESSAGE,response.msg);}else{me.dataFieldLabel.getEl().unmask();me.dataFieldLabel.setValue(response.data.title);me.updateLayout();}},failure:function(){me.dataFieldLabel.getEl().unmask();app.ajaxFailure(arguments);}});}});Ext.ns('app.orm.connections');Ext.define('app.orm.connections.Window',{extend:'Ext.Window',dataGrid:null,dataStore:null,controllerUrl:'',dbConfigs:null,modal:true,constructor:function(config){config=Ext.apply({title:appLang.DB_CONNECTIONS,width:700,height:300,layout:'fit',closeAction:'destroy',maximizable:true},config||{});this.callParent(arguments);},initComponent:function(){var me=this;var defaultConnectionId=this.dbConfigs[0]['id'];this.dataStore=Ext.create('Ext.data.Store',{fields:[{name:'id',type:'string'},{name:'system',type:'boolean'},{name:'devType',type:'integer'},{name:'username',type:'string'},{name:'dbname',type:'string'},{name:'host',type:'string'},{name:'adapter',type:'string'}],proxy:{type:'ajax',url:this.controllerUrl+'list',extraParams:{devType:defaultConnectionId},reader:{type:'json',rootProperty:'data',idProperty:'id'},simpleSortMode:true},remoteSort:false,autoLoad:true,sorters:[{property:'id',direction:'DESC'}]});this.filter=Ext.create('Ext.form.field.ComboBox',{typeAhead:true,triggerAction:'all',selectOnTab:true,labelWidth:80,forceSelection:true,queryMode:'local',displayField:'title',valueField:'id',value:defaultConnectionId,store:Ext.create('Ext.data.Store',{fields:[{name:'id',type:'integer'},{name:'title',type:'string'}],data:this.dbConfigs}),listeners:{change:{fn:function(){this.dataStore.proxy.setExtraParam('devType',this.filter.getValue());this.dataStore.load();},scope:this}}});this.dataGrid=Ext.create('Ext.grid.Panel',{store:this.dataStore,viewConfig:{stripeRows:false},frame:false,loadMask:true,columnLines:true,scrollable:true,forceFit:true,viewConfig:{enableTextSelection:true},tbar:[{text:appLang.ADD_ITEM,handler:function(){this.showEditWindow(false,this.filter.getValue());},scope:this},'-',appLang.TYPE,this.filter],columns:[{xtype:'actioncolumn',width:30,items:[{iconCls:'editIcon',width:30,scope:this,handler:function(grid,rowIndex,colIndex){var rec=this.dataStore.getAt(rowIndex);this.showEditWindow(rec.get('id'),rec.get('devType'));}}]},{text:appLang.NAME,dataIndex:'id'},{sortable:true,text:appLang.DB_HOST,dataIndex:'host',align:'center'},{sortable:true,text:appLang.DB_NAME,dataIndex:'dbname',align:'center'},{sortable:true,text:appLang.USER,dataIndex:'username',align:'center'},{sortable:true,text:appLang.DB_ADAPTER,dataIndex:'adapter',align:'center'},{width:30,align:'center',dataIndex:'system',colid:'deleteindex',renderer:function(value,metaData,record,rowIndex,colIndex,store){if(value){return'<img src="'+app.wwwRoot+'i/system/locked.png" title="'+appLang.SYSTEM_PROTECTED_FIELD+'">';}else{return'<img src="'+app.wwwRoot+'i/system/delete.png" title="'+appLang.DELETE_ITEM+'" style="cursor:pointer;">';}}}],listeners:{'itemdblclick':{fn:function(view,record,number,event,options){this.showEditWindow(record.get('id'),record.get('devType'));},scope:this},'cellclick':{fn:function(grid,cell,columnIndex,record,node,rowIndex,evt){var column=grid.getHeaderCt().getHeaderAtIndex(columnIndex).colid;if(record.get('primary'))
return;switch(column){case'deleteindex':if(record.get('system')){return;}
this.removeItem(record);break;}},scope:this}}});this.items=[this.dataGrid];this.callParent();this.on('show',function(){app.checkSize(this);});},removeItem:function(record){Ext.Ajax.request({url:this.controllerUrl+'remove',method:'post',scope:this,params:{'id':record.get('id')},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.dataStore.remove(record);}else{Ext.Msg.alert(appLang.MESSAGE,response.msg);}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION);}});},showEditWindow:function(id,devtype){var win=Ext.create('app.orm.connections.EditWindow',{recordId:id,devType:devtype,controllerUrl:this.controllerUrl});win.on('dataSaved',function(){this.dataStore.load();},this);win.show();}});Ext.define('app.orm.connections.EditWindow',{extend:'Ext.Window',dataForm:null,recordId:null,controllerUrl:'',devType:false,recordId:false,constructor:function(config){config=Ext.apply({title:appLang.DB_CONNECTIONS,width:400,height:430,layout:'fit',modal:true,closeAction:'destroy',maximizable:false},config||{});this.callParent(arguments);},initComponent:function(){this.dataForm=Ext.create('Ext.form.Panel',{bodyCls:'formBody',bodyPadding:10,fieldDefaults:{anchor:'100%',labelWidth:140},items:[{xtype:'textfield',fieldLabel:appLang.NAME,allowBlank:false,vtype:'alphanum',value:'',name:'id'},{xtype:'textfield',fieldLabel:appLang.DB_HOST,allowBlank:false,name:'host'},{xtype:'textfield',fieldLabel:appLang.DB_PORT,allowBlank:true,name:'port'},{xtype:'textfield',fieldLabel:appLang.DB_NAME,allowBlank:false,name:'dbname'},{xtype:'textfield',fieldLabel:appLang.DB_CHARSET,allowBlank:false,value:'UTF8',name:'charset'},{xtype:'textfield',fieldLabel:appLang.DB_PREFIX,name:'prefix'},Ext.create('Ext.form.field.ComboBox',{xtype:'combo',name:'adapter',fieldLabel:appLang.DB_ADAPTER,queryMode:'local',allowBlank:false,forceSelection:true,displayField:'title',valueField:'title',value:'Mysqli',store:Ext.create('Ext.data.Store',{fields:[{name:'title',type:'string'}],data:[{title:'Mysqli'}],sorters:[{property:'title',direction:'ASC'}]})}),Ext.create('Ext.form.field.ComboBox',{xtype:'combo',allowBlank:false,name:'adapterNamespace',fieldLabel:appLang.DB_ADAPTER_NAMESPACE,queryMode:'local',forceSelection:true,displayField:'title',valueField:'id',value:'Db_Adapter',store:Ext.create('Ext.data.Store',{fields:[{name:'id',type:'string'},{name:'title',type:'string'}],data:[{title:'DVelum (recomended)',id:'Db_Adapter'},{title:'Zend',id:'Zend_Db_Adapter'}],sorters:[{property:'title',direction:'ASC'}]})}),{xtype:'textfield',fieldLabel:appLang.USER,allowBlank:false,name:'username'},{name:'setpass',value:1,readOnly:true,fieldLabel:appLang.CHANGE_PASSWORD,submitValue:true,checked:true,readOnly:true,xtype:'checkbox',listeners:{change:{fn:this.denyBlankPassword,scope:this,buffer:350}}},{fieldLabel:appLang.PASSWORD,inputType:"password",name:"password",xtype:"textfield",enableKeyEvents:true,allowBlank:false},{fieldLabel:appLang.PASSWORD_CONFIRM,inputType:"password",name:"pass2",submitValue:false,xtype:"textfield",enableKeyEvents:true,vtype:'password',initialPassField:'password',allowBlank:false}]});this.buttons=[{text:appLang.TEST,scope:this,handler:this.testAction},{text:appLang.SAVE,scope:this,handler:this.saveAction},{text:appLang.CANCEL,scope:this,handler:this.close},];this.items=[this.dataForm];this.callParent(arguments);if(this.recordId){this.dataForm.load({url:this.controllerUrl+'load',params:{id:this.recordId,devType:this.devType},scope:this,success:function(form,action){if(action.result.success){form.findField('setpass').enable();form.findField('setpass').setValue(false);form.findField('setpass').setReadOnly(false);}else{Ext.Msg.alert(appLang.MESSAGE,action.result.msg);}},failure:app.formFailure});}},denyBlankPassword:function(field,bool){var handle=this.dataForm.getForm();if(!bool){handle.findField('password').disable();handle.findField('pass2').disable();}else{handle.findField('password').enable();handle.findField('pass2').enable();}
handle.findField('password').allowBlank=!bool;handle.findField('pass2').allowBlank=!bool;},saveAction:function(){this.dataForm.getForm().submit({clientValidation:true,waitMsg:appLang.SAVING,method:'post',scope:this,url:this.controllerUrl+'save',params:{oldid:this.recordId,devType:this.devType},success:function(form,action){if(!action.result.success){Ext.Msg.alert(appLang.MESSAGE,action.result.msg);}else{this.fireEvent('dataSaved');this.close();}},failure:app.formFailure});},testAction:function(){this.dataForm.getForm().submit({clientValidation:true,waitMsg:appLang.CHECKING,method:'post',scope:this,url:this.controllerUrl+'test',params:{devType:this.devType},success:function(form,action){if(action.result.success){Ext.Msg.alert(appLang.MESSAGE,appLang.SUCCESS);}else{Ext.Msg.alert(appLang.MESSAGE,action.result.msg);}},failure:app.formFailure});}});Ext.define('app.crud.orm.logWindow',{extend:'Ext.Window',controllerUrl:'',width:600,height:600,closeAction:'destroy',layout:'fit',title:appLang.LOG,bodyPadding:5,scrollable:true,displayField:false,bodyStyle:{backgroundColor:'#ffffff'},initComponent:function(){this.displayField=Ext.create('Ext.form.Display',{name:'text'});this.items=[this.displayField];this.fileSelector=Ext.create('Ext.form.field.ComboBox',{allowBlank:false,editable:false,forceSelection:true,queryMode:'local',displayField:'id',valueField:'id',name:'file',store:Ext.create('Ext.data.Store',{fields:[{name:'id',type:'string'}],autoLoad:true,proxy:{type:'ajax',url:this.controllerUrl+'getlogfiles',reader:{rootProperty:'data',idProperty:'id'}},listeners:{load:{fn:function(store,records){this.fileSelector.setValue(records[0].get('id'));},scope:this}}}),listeners:{change:{fn:function(cmp,value){this.loadLog(value);},scope:this}}});this.tbar=[appLang.FILE+':',this.fileSelector];this.callParent();},setText:function(text){this.displayField.setValue(text);},loadLog:function(filename){var me=this;Ext.Ajax.request({url:me.controllerUrl+'getlog',method:'post',params:{file:filename},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){me.setText(response.data);}else{Ext.Msg.alert(appLang.ERROR,response.msg);}},failure:app.formFailure});}});Ext.ns('app.orm.import');Ext.define('app.orm.import.Window',{extend:'Ext.Window',dataGrid:null,controllerUrl:'',dbConfigs:null,modal:true,layout:'border',constructor:function(config){config=Ext.apply({title:appLang.ORM_IMPORT,width:700,height:400,bodyCls:'formBody',closeAction:'destroy',maximizable:true},config||{});this.callParent(arguments);},initComponent:function(){this.dataGrid=Ext.create('Ext.grid.Panel',{title:appLang.DB_TABLES,region:'center',scrollable:true,hideHeaders:true,columnLines:true,store:Ext.create('Ext.data.Store',{fields:[{name:'name',type:'string'}],proxy:{url:app.createUrl([app.admin,'orm','connections','externaltables']),type:'ajax',reader:{type:'json',idProperty:'name',rootProperty:'data'},extraParams:{'type':0,'connId':'default'}},autoLoad:false,sorters:[{property:'name',direction:'ASC'}]}),columns:[{dataIndex:'name',flex:1}]});this.typeField=Ext.create('Ext.form.field.ComboBox',{typeAhead:false,triggerAction:'all',forceSelection:true,displayField:'title',valueField:'id',queryMode:'local',allowBlank:false,fieldLabel:appLang.TYPE,value:0,store:Ext.create('Ext.data.Store',{fields:[{name:'id',type:'integer'},{name:'title',type:'string'}],proxy:{type:'ajax',url:app.createUrl([app.admin,'orm','connectiontypes']),reader:{type:'json',rootProperty:'data',idProperty:'id'}},autoLoad:true,sorters:[{property:'title',direction:'ASC'}]}),listeners:{select:function(field,records,options){var store=this.dataGrid.getStore();store.removeAll();store.proxy.setExtraParam('type',records.get('id'));if(store.proxy.extraParams['connId']){store.load();}},scope:this}});this.connectionField=Ext.create('Ext.form.field.ComboBox',{fieldLabel:appLang.DB_CONNECTION,queryMode:'local',typeAhead:true,forceSelection:true,displayField:'id',valueField:'id',value:'default',store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',proxy:{type:'ajax',url:app.createUrl([app.admin,'orm','connectionslist']),reader:{type:'json',rootProperty:'data',idProperty:'id'}},autoLoad:true,sorters:[{property:'id',direction:'ASC'}]}),listeners:{select:function(field,records,options){var store=this.dataGrid.getStore();store.removeAll();store.proxy.extraParams['connId']=records.get('id');if(store.proxy.extraParams['type']){store.load();}},scope:this}});this.importForm=Ext.create('Ext.form.Panel',{frame:false,region:'north',margin:5,border:false,bodyCls:'formBody',height:70,fieldDefaults:{labelAlign:'right',labelWidth:120},items:[this.connectionField,this.typeField]});this.items=[this.importForm,this.dataGrid];this.buttons=[{text:appLang.DB_CONNECT_EXTERNAL,handler:this.importTable,scope:this}];this.callParent();},importTable:function(){var sm=this.dataGrid.getSelectionModel();if(!sm.hasSelection()){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_SELECT_TABLE_FOR_CONNECT);return;}
var me=this;me.getEl().mask(appLang.LOADING);Ext.Ajax.request({url:app.createUrl([app.admin,'orm','connections','connectobject']),method:'post',params:{type:this.typeField.getValue(),connId:this.connectionField.getValue(),table:sm.getSelection()[0].get('name')},scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){me.getEl().unmask();Ext.Msg.alert(appLang.MESSAGE,response.msg);}else{me.getEl().unmask();me.fireEvent('importComplete');me.close();}},failure:function(){me.getEl().unmask();app.ajaxFailure(arguments);}});}});Ext.define('app.crud.orm.taskStatusWindow',{extend:'Ext.Window',controllerUrl:null,extraParams:null,width:450,height:140,modal:true,closable:false,resizable:false,checkInterval:2000,progressBar:null,layout:'anchor',timerId:null,bodyPadding:'5px',initComponent:function(){this.processLabel=Ext.create('Ext.form.field.Display',{value:'<div align="center"><b>'+appLang.PROCESSING+'<b></div>',anchor:'100%'});this.progressBar=Ext.create('Ext.ProgressBar',{anchor:'100%'});var me=this;this.closeBtn=Ext.create('Ext.Button',{text:appLang.CLOSE,hidden:true,handler:function(){me.close();}});this.items=[this.processLabel,this.progressBar];this.fbar=[this.closeBtn];this.callParent();var me=this;setTimeout(function(){me.checkState();},this.checkInterval);},checkState:function(){var me=this;Ext.Ajax.request({url:me.controllerUrl,method:'post',params:me.extraParams,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){switch(parseInt(response.data.status)){case 0:case 1:case 2:me.updateState(response.data);if(me.timerId){clearTimeout(me.timerId);}
me.timerId=setTimeout(function(){me.checkState();},me.checkInterval);break;case 3:case 4:me.updateState(response.data);me.fireEvent('finished',response.data);me.closeBtn.show();me.processLabel.setValue('<div align="center"><b>'+appLang.COMPLETED+'<b></div>');break;case 5:me.fireEvent('failure','Task Error');me.closeBtn.show();me.processLabel.setValue('<div align="center"><b>'+appLang.ERROR+'<b></div>');break;}}else{me.fireEvent('failure',response.msg);}},failure:function(form,action){me.fireEvent('failure',appLang.MSG_LOST_CONNECTION);}});},updateState:function(data)
{var value=data.op_finished/data.op_total;this.progressBar.updateProgress(value,data.op_finished+'/'+data.op_total,true);this.fireEvent('updateState',data);}});